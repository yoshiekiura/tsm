editor=window.top.tinyMCE.activeEditor;topWindow=window.top;var mcegmaps_width=editor.getParam("mcegmaps_width")||400;var mcegmaps_height=editor.getParam("mcegmaps_height")||320;var mcegmaps_default_zoom=editor.getParam("mcegmaps_default_zoom")||3;var mcegmaps_default_x=editor.getParam("mcegmaps_default_x")||35;var mcegmaps_default_y=editor.getParam("mcegmaps_default_y")||-93;var mcegmaps_default_address=editor.getParam("mcegmaps_default_address");var mcegmaps_auto_scaling_on_search=editor.getParam("mcegmaps_auto_scaling_on_search")==undefined?true:editor.getParam("mcegmaps_auto_scaling_on_search");layersDialog=(function(){return{selectedOpts:{},open:function(){$("#layers-form").dialog("open");},close:function(){$("#layers-form").dialog("close");},updateLayers:function(){this.trafficLayer.setMap(this.selectedOpts.traffic_layer?this.map:null);this.weatherLayer.setMap(this.selectedOpts.weather_layer?this.map:null);},updateCheckboxes:function(){$("#traffic_layer").attr("checked",!!this.selectedOpts.traffic_layer);$("#weather_layer").attr("checked",!!this.selectedOpts.weather_layer);},init:function(b){var a=this;this.map=b;this.trafficLayer=new google.maps.TrafficLayer();this.weatherLayer=new google.maps.weather.WeatherLayer({temperatureUnits:google.maps.weather.TemperatureUnit.FAHRENHEIT,});$("#layers-form").dialog({autoOpen:false,height:170,width:350,modal:true,buttons:{Ok:function(){a.selectedOpts.traffic_layer=$("#traffic_layer").is(":checked");a.selectedOpts.weather_layer=$("#weather_layer").is(":checked");a.updateLayers();a.close();},Cancel:function(){a.close();}},open:function(){a.updateCheckboxes();}});}};})();settingsDialog=(function(){return{open:function(){$("#settings-form").dialog("open");},close:function(){$("#settings-form").dialog("close");},updateSettings:function(){var a=this.map;$("#settings-form form input").each(function(){a.set(this.name,$(this).is(":checked"));});},getSettings:function(){var a={},b=this.map;$("#settings-form form input").each(function(){a[this.name]=b.get(this.name);});return a;},setSettings:function(a){var b=this.map;$("#settings-form form input").each(function(){b.set(this.name,a[this.name]);});},updateSettingsCheckboxes:function(){var a=this.map;$("#settings-form form input").each(function(){$(this).attr("checked",a.get(this.name));});},init:function(b){var a=this;this.map=b;$("#settings-form").dialog({autoOpen:false,width:350,modal:true,buttons:{Ok:function(){a.updateSettings();a.close();},Cancel:function(){a.close();}},open:function(){a.updateSettingsCheckboxes();}});}};})();redRectangle=(function(){return{divs:null,updateSpinnersFromParams:function(){$("#map-width").val(mcegmaps_width);$("#map-height").val(mcegmaps_height);},updatePositions:function(){var e=$("#map-canvas").offset();var d=$("#map-canvas").outerWidth(),b=$("#map-canvas").outerHeight(),a=Math.round(d/2-mcegmaps_width/2),c=Math.round(b/2-mcegmaps_height/2);this.divs.each(function(g){var f=$(this);var h={top:c+"px",left:a+"px",};switch(g){case 0:h.width=mcegmaps_width+"px";break;case 1:h.height=mcegmaps_height+"px";break;case 2:h.top=(mcegmaps_height+c)+"px";h.width=mcegmaps_width+"px";break;case 3:h.height=mcegmaps_height+"px";h.left=(mcegmaps_width+a)+"px";break;}f.css(h);});},initRectDivs:function(){this.divs=$("<div/><div/><div/><div/>");this.divs.each(function(b){var a=$(this);var c={position:"absolute",zIndex:99,border:"1px solid #BB1111"};if(b%2){c=$.extend(c,{width:"1px",height:mcegmaps_height+"px",borderWidth:"0px 0px 0px 1px"});}else{c=$.extend(c,{height:"1px",width:mcegmaps_width+"px",borderWidth:"1px 0px 0px 0px"});}a.css(c);}).appendTo($("#map-canvas"));},initSpinners:function(){var a=this;var b=function(){mcegmaps_width=+$("#map-width").val();mcegmaps_height=+$("#map-height").val();a.updatePositions();};$("#map-width").spinner({min:10,max:screen.width,change:b,stop:b});$("#map-height").spinner({min:10,max:screen.height,change:b,stop:b});$("#map-width").val(mcegmaps_width);$("#map-height").val(mcegmaps_height);},init:function(){this.initRectDivs();this.initSpinners();var a=this;setTimeout(function(){a.updatePositions();},0);}};})();insertButtons=(function(){return{objects:{Marker:[],Circle:[],Polyline:[],Text:[],Polygon:[],Rectangle:[],TrafficLayer:[],WeatherLayer:[],},mode:null,insertMarker:function(f,a,g,c){var b=this;var e=new google.maps.Marker({position:a,map:f,draggable:true,title:g});var d=function(){var j='<div style="width:250px;height:150px">'+'<div id="content" style="position:relative; z-index:999;">'+'<label>Text</label><div style="margin:5px;">'+'<textarea id="area1" rows="5" style="width:99%;resize: none;">{text}</textarea>'+"</div>"+"<div>"+'<input onclick="insertButtons.currentMarker&&insertButtons.currentMarker.setMap(null);delete insertButtons.objects.Marker[insertButtons.objects.Marker.indexOf(insertButtons.currentMarker)]; return false;" style="float:left;" type="button" value="Delete"/>'+'<input onclick="insertButtons.currentMarker&&insertButtons.currentMarker.setTitle(document.getElementById(\'area1\').value);insertButtons.infoWindow&&insertButtons.infoWindow.close();return false;" style="float:right;" type="button" value="OK"/>'+'<input onclick="insertButtons.infoWindow&&insertButtons.infoWindow.close();return false;" style="float:right;" type="button" value="Cancel"/>'+'<div style="clear:both;"></div>'+"</div>"+"</div>"+"</div>";
var i=this;b.currentMarker=i;var h=i.getPosition();b.infoWindow.setContent(j.replace("{text}",this.getTitle()));b.infoWindow.open(f,this);};google.maps.event.addListener(e,"click",d);c&&d.apply(e);return e;},insertText:function(h,c,a,e,f){var d=this;var b=new MarkerWithLabel({position:a,draggable:true,raiseOnDrag:true,map:h,labelContent:c,labelAnchor:new google.maps.Point(22,0),labelClass:"labels",labelStyle:{opacity:1,minWidth:"200px",fontSize:f,textAlign:"left"},icon:{}});var g=function(){var j='<div id="content" style="position:relative; z-index:999;width:400px;heigth:400px">'+'<label>Text</label><div style="margin:5px;">'+'<textarea id="area2" rows="5" style="width:99%;resize: none;">{text}</textarea>'+"</div>"+"<div>"+'<input onclick="return insertButtons.deleteCurrentText();" style="float:left;" type="button" value="Delete"/>'+'<input onclick="return insertButtons.okCurrentText();" style="float:right;" type="button" value="OK"/>'+'<input onclick="return insertButtons.cancelCurrentText();" style="float:right;" type="button" value="Cancel"/>'+'<div style="clear:both;"></div>'+"</div>"+"</div>";d.currentMarker=this;var i=this.getPosition();d.infoWindow.setContent(j.replace("{text}",this.get("labelContent")));d.infoWindow.open(h,this);d.showFontChooser(parseInt(this.labelStyle.fontSize));};google.maps.event.addListener(b,"click",g);e&&g.apply(b);return b;},insertCircle:function(d,b,a,c){return new google.maps.Circle({radius:a,center:b,map:d,editable:true,draggable:true,strokeColor:c||"#ff0000"});},insertRectangle:function(c,b,a){return new google.maps.Rectangle({bounds:b,map:c,editable:true,draggable:true,strokeColor:a||"#ff0000"});},insertPolyFigure:function(d,c,b,a){return new google.maps[d]({path:b,map:c,editable:true,draggable:true,strokeColor:a||"#ff0000"});},insertPolygon:function(c,b,a){return this.insertPolyFigure("Polygon",c,b,a);},insertPolyline:function(b,a){return this.insertPolyFigure("Polyline",b,a);},finishInsertingShape:function(){this.clearActiveButtons();$("#finish_path").hide();this.hideColorChooser();this.hideFontChooser();this.mode=null;this.map.setOptions({draggableCursor:"move"});},cancelInsertingShape:function(){this.deleteObject(this.currentObject.type,insertButtons.objects[this.currentObject.type].indexOf(this.currentObject));this.finishInsertingShape();},deleteCurrentText:function(){this.currentMarker&&this.currentMarker.setMap(null);delete this.objects.Text[this.objects.Text.indexOf(this.currentMarker)];this.hideFontChooser();return false;},okCurrentText:function(){this.currentMarker&&this.currentMarker.set("labelContent",$("#area2").val());this.infoWindow&&this.infoWindow.close();this.hideFontChooser();return false;},cancelCurrentText:function(){this.infoWindow&&this.infoWindow.close();this.hideFontChooser();return false;},deleteObject:function(b,a){a=isNaN(a)?0:a;if(!this.objects[b].length){return 0;}this.objects[b][a].setMap(null);delete this.objects[b][a];this.objects[b].splice(a,1);},clearActiveButtons:function(){$("button.object").removeClass("active");},changeMarkerFont:function(a){var c=this.currentMarker||this.currentObject;var b=c.labelStyle;b.fontSize=a+"px";c.set("labelStyle",b);},showFontChooser:function(a){$("#fontChooser").show();if(!a){a=24;}this.changeMarkerFont(a);$(".font-item").removeClass("active-font-item");$(".font-item:contains("+a+")").addClass("active-font-item");},hideFontChooser:function(){$("#fontChooser").hide();},changeObjColor:function(a){this.currentObject.set("strokeColor",a);return;var c=this.currentMarker||this.currentObject;var b=c.labelStyle;b.fontSize=size+"px";c.set("labelStyle",b);},showColorChooser:function(a){$("#colorChooser").show();if(!a){a="red";}this.changeObjColor(a);$(".color-item").removeClass("active-color-item");$(".color-item.with-color-"+a.replace("#","\\#")).addClass("active-color-item");},hideColorChooser:function(){$("#colorChooser").hide();},initColorButtons:function(){var a=this;$(".color-item").click(function(){var b=$(this).attr("class").match(/with-color-(.*)/);a.showColorChooser(b[1]);});},initFontButtons:function(){var a=this;$(".font-item").click(function(){a.showFontChooser($(this).html());});},init:function(c){this.map=c;this.currentMarker=0;this.infoWindow=new google.maps.InfoWindow;this.objects={Marker:[],Circle:[],Polyline:[],Text:[],Polygon:[],Rectangle:[],TrafficLayer:[],WeatherLayer:[],};var b=this;$.each(["Circle","Marker","Text","Polygon","Polyline","Rectangle"],function(d,e){b["insert"+e+"X"]=function(){var f=this["insert"+e].apply(b,arguments);b.objects[e].push(f);return f;};});var a=$("button.object");a.click(function(){var d=!$(this).hasClass("active");b.clearActiveButtons();b.mode=d?$(this).val():"";if(!d){$(this).removeClass("active");}else{$(this).addClass("active");}c.setOptions({draggableCursor:d?"crosshair":"move"});$("#finish_path").hide();b.hideFontChooser();b.hideColorChooser();});clickAddObject=function(d){var k=b.mode;var j=d.latLng||c.getCenter(),l=Math.pow(2,c.getZoom()),f=c.getProjection().fromLatLngToPoint(j),h=50,i=null,g=c.getProjection().fromPointToLatLng(new google.maps.Point(f.x-(h/2)/l,f.y-(h/2)/l)),e=c.getProjection().fromPointToLatLng(new google.maps.Point(f.x+(h/2)/l,f.y+(h/2)/l));
switch(k){case"Marker":i=b.insertMarkerX(c,j,"Hello World!",true);break;case"Rectangle":i=b.insertRectangleX(c,new google.maps.LatLngBounds(g,e));break;case"Polyline":i=b.insertPolylineX(c,[j]);break;case"Polygon":i=b.insertPolygonX(c,[j]);break;case"addpointtocoord":if(b.currentObject instanceof google.maps.Polyline||b.currentObject instanceof google.maps.Polygon){var m=b.currentObject.getPath();m.push(j);b.currentObject.setPath(m);}else{b.mode="";}break;case"Text":i=b.insertTextX(c,"Hello World!",j,true,"24px");break;case"Circle":i=b.insertCircleX(c,j,google.maps.geometry.spherical.computeDistanceBetween(g,e));break;case"WeatherLayer":deleteObject(k);i=new google.maps.weather.WeatherLayer({temperatureUnits:google.maps.weather.TemperatureUnit.FAHRENHEIT,});i.setMap(c);break;case"TrafficLayer":deleteObject(k);i=new google.maps.TrafficLayer();i.setMap(c);break;}if(i&&k!="addpointtocoord"){google.maps.event.addListener(i,"click",function(){b.currentObject=this;});b.currentObject=i;i.type=k;if(k=="Text"){b.showFontChooser();}if(k!="Marker"&&k!="Text"){b.showColorChooser();}if(k!="Polyline"&&k!="Polygon"){$(".object").removeClass("active");c.setOptions({draggableCursor:"move"});b.mode="";}else{b.mode="addpointtocoord";$("#finish_path").show();}}};google.maps.event.addListener(c,"click",clickAddObject);this.initFontButtons();this.initColorButtons();}};})();map=(function(){function c(d){var f=this.map;var e=this;(new google.maps.Geocoder()).geocode({"address":d},function(h,g){if(g==google.maps.GeocoderStatus.OK){e.setCenterWithAutoScaling(h[0]);mcegmaps_default_x=h[0].geometry.location.lat();mcegmaps_default_y=h[0].geometry.location.lng();}});}function a(){var d=new google.maps.LatLng(mcegmaps_default_x,mcegmaps_default_y);var e={zoom:mcegmaps_default_zoom,center:d,disableDefaultUI:true,disableDoubleClickZoom:false,draggable:true,mapTypeControl:true,zoomControl:true,rotateControl:false,scaleControl:true,streetViewControl:false,panControl:false,overviewMapControl:false,draggableCursor:"move",mapTypeId:google.maps.MapTypeId.ROADMAP};var g=this.map=new google.maps.Map($("#map-canvas")[0],e);if(mcegmaps_default_address&&!window.top.dataForLoadIntoMap){this.tryToGeoCodeAddress(mcegmaps_default_address);}google.maps.event.addDomListener(g,"maptypeid_changed",function(){var i=g.getMapTypeId();$("#maptype_img").attr("src","images/"+i+".png");$("#maptype_title").html(i.charAt(0).toUpperCase()+i.slice(1));});this.map.setMapTypeId("roadmap");function h(){function i(){g.setZoom(+$(this).val());}google.maps.event.addDomListener(g,"zoom_changed",function(){$("#map-zoom").val(g.getZoom());});$("#map-zoom").spinner({min:0,change:i,stop:i,max:20});$("#map-zoom").val(mcegmaps_default_zoom);}function f(){var j=new google.maps.places.SearchBox($("#target")[0]);j.bindTo("bounds",g);var i=this;google.maps.event.addListener(j,"places_changed",function(){var k=j.getPlaces()[0];i.map.setCenterWithAutoScaling(k);});}h();f();}var b;$.get("./editor-code.html",function(d){b=d.replace(/\s+/g," ");});return{map:null,init:a,tryToGeoCodeAddress:c,setCenterWithAutoScaling:function(d){if(!mcegmaps_auto_scaling_on_search){this.map.setCenter(d.geometry.location);return true;}else{if(d.geometry.viewport){this.map.fitBounds(d.geometry.viewport);}else{this.map.setZoom(17);this.map.setCenter(d.geometry.location);}}},getNewMapId:function(){for(var d=1;d<100;d++){var e="mcegmap_"+d;if(!editor.dom.doc.getElementById(e)){return e;}}},getHtmlCode:function(){return b.replace(/{{map-id}}/g,this.getNewMapId()).replace("{{map-json}}",JSON.stringify(this.generateCodeMap()));},generateCodeMap:function(){var e=this.map;var j=insertButtons.objects;var n={lat:e.getCenter().lat(),lng:e.getCenter().lng(),zoom:e.getZoom(),type:e.getMapTypeId(),width:mcegmaps_width,height:mcegmaps_height,settings:{},objects:{Marker:[],Circle:[],Polyline:[],Text:[],Polygon:[],Rectangle:[],TrafficLayer:[],WeatherLayer:[],},};$.each(layersDialog.selectedOpts,function(o,p){n.settings[o]=p;});$.each(settingsDialog.getSettings(),function(o,p){n.settings[o]=p;});for(var f in j){for(var k in j[f]){if(!j[f][k]){continue;}var g=j[f][k];switch(f){case"Marker":n.objects[f].push([j[f][k].getPosition().lat(),j[f][k].getPosition().lng(),j[f][k].getTitle()]);break;case"Circle":n.objects[f].push([g.get("strokeColor"),j[f][k].getCenter().lat(),j[f][k].getCenter().lng(),j[f][k].getRadius()]);break;case"Text":n.objects[f].push([g.getPosition().lat(),g.getPosition().lng(),g.get("labelContent"),g.get("labelStyle").fontSize]);break;case"Rectangle":n.objects[f].push([g.get("strokeColor"),[g.getBounds().getSouthWest().lat(),g.getBounds().getSouthWest().lng()],[g.getBounds().getNorthEast().lat(),g.getBounds().getNorthEast().lng()]]);break;case"Polygon":case"Polyline":var h=g.getPath().getArray(),m=[g.get("strokeColor")];for(var l in h){m.push([h[l].lat(),h[l].lng()]);}n.objects[f].push(m);break;case"Polygon":var h=g.getPath().getArray(),m=[g.get("strokeColor")],i;for(var l in h){i=[];
var i=h[l].getArray();for(var d in i){q.push([i[d].lat(),i[d].lng()]);}m.push(q);}n.objects[f].push(m);break;case"TrafficLayer":case"WeatherLayer":n.objects[f].push(1);break;}}}return n;},loadMapFromJSON:function(l){var e=this.map;l.width&&(mcegmaps_width=l.width);l.height&&(mcegmaps_height=l.height);redRectangle.updateSpinnersFromParams();redRectangle.updatePositions();var d=new google.maps.LatLng(parseFloat(l.lat),parseFloat(l.lng));e.setCenter(d);e.setZoom(parseInt(l.zoom));e.setMapTypeId(l.type);$.each(["traffic_layer","weather_layer"],function(i,n){layersDialog.selectedOpts[n]=l.settings[n];});layersDialog.updateLayers();settingsDialog.setSettings(l.settings);if(l.objects){for(var f in l.objects){for(var k in l.objects[f]){var d=new google.maps.LatLng(0,0);var j=l.objects[f][k];switch(f){case"Marker":d=new google.maps.LatLng(l.objects[f][k][0],l.objects[f][k][1]);insertButtons.insertMarkerX(e,d,l.objects[f][k][2],false);break;case"Circle":d=new google.maps.LatLng(l.objects[f][k][1],l.objects[f][k][2]);insertButtons.insertCircleX(e,d,l.objects[f][k][3],l.objects[f][k][0]);break;case"Text":d=new google.maps.LatLng(j[0],j[1]);insertButtons.insertTextX(e,j[2],d,false,j[3]);break;case"Rectangle":var g=new google.maps.LatLngBounds(new google.maps.LatLng(l.objects[f][k][1][0],l.objects[f][k][1][1]),new google.maps.LatLng(l.objects[f][k][2][0],l.objects[f][k][2][1]));insertButtons.insertRectangleX(e,g,l.objects[f][k][0]);break;case"Polygon":case"Polyline":var m=[];for(var h=1;h<j.length;h++){m.push(new google.maps.LatLng(j[h][0],j[h][1]));}if(f=="Polygon"){insertButtons.insertPolygonX(e,m,j[0]);}else{insertButtons.insertPolylineX(e,m,j[0]);}break;}}}}this.mode=l.type;},doNextMapType:function(){var f=["roadmap","satellite","terrain","hybrid"],d=f.indexOf(this.map.getMapTypeId()),e=(d+1)%f.length;this.map.setMapTypeId(f[e]);}};})();function updateMapHeight(){document.getElementById("map-canvas").style.height=(window.innerHeight-55)+"px";}$(function(){map.init();layersDialog.init(map.map);settingsDialog.init(map.map);redRectangle.init();insertButtons.init(map.map);if(window.top.dataForLoadIntoMap){map.loadMapFromJSON(window.top.dataForLoadIntoMap);}updateMapHeight();});